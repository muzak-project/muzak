#!/usr/bin/env ruby

require "muzak"
require "shellwords"

Process.daemon unless Muzak::Config.debug || Muzak::Config.verbose
Thread.abort_on_exception = Muzak::Config.debug

muzak = Muzak::Instance.new

fifo_path = File.join(Muzak::CONFIG_DIR, "muzak.fifo")
File.delete(fifo_path) if File.exist?(fifo_path) # just in case a previous session died
File.mkfifo(fifo_path)

File.open(fifo_path, "r+") do |fifo|
  loop do
    cmd_argv = Shellwords.split(fifo.readline) rescue next
    next if cmd_argv.empty? || cmd_argv.any?(&:empty?)
    cmd = cmd_argv.shift
    muzak.command cmd, *cmd_argv
    break if cmd == "quit"
  end
end

File.delete(fifo_path) if File.exist?(fifo_path)
